# Перевод anycubic ace pro на happy hare
Данная статья посвящена переведу anycubic ace pro на happy hare. Статья подразумевает что у вас уже поставлен klipper, веб интрфейс, а также умеете подключаться к хосту по ssh и вы имеете представления о stm32, klipper

0. [Драйвера](#Драйвера)
1. [Преимущества](#Благодарность)
2. [Преимущества](#Преимущества-над-выше-перечисленными-проектами)
3. [Обозначения](#Обозначения)
4. [Автор](#Автор)
5. [Пути реализации](#Пути-реализации)
6. [Сушикла](#Сушилка)
7. [Прошивка стоковой платы через swd](#Прошивка-стоковой-платы-через-swd)
8. [Прошивка стоковой платы через dfu](#Прошивка-стоковой-платы-через-dfu)

# Драйвера
Если вы наткнулись на эту статью и не готовы так заморачиваться, можете воспользоваться данными проектами
- https://github.com/BlackFrogKok/BunnyACE/blob/development/README.ru.md
- https://github.com/agrloki/ValgACE
  
# Благодарность:
- https://github.com/printers-for-people/ACEResearch
- [@niknikdm](https://web.telegram.org/k/#@niknikdm) (реализует способ с заменой платы)
# Автор 
Пишите по всем вопросам, чем смогу тем помогу :)
- [@saturnechek](https://web.telegram.org/k/#@saturnechek)

  
# Преимущества над выше перечисленными проектами:
- Гибкость настройки 
- Стабильность работы 
- Удобный веб интерфейс
- klipperscreen под mmu 
- Возможность подключения к самой асе дополнительных датчиков(если ну нужен nfc освобождается 12 пинов), например таких как bme280(для отображения реальной температуры и влажности в камере сушилки, а не погоду в блоке грелок), дисплеев и тд 


# Обозначения:
| Обозначение | Сокращение |
|:----:|:----:|
| Happy hare | hh |
| Anycubic ace pro | ace |
| Блок питанияe | бп |



# Пути реализации
| Путь | Минусы | Плюсы |
|:----:|:------|:------|
| [текст](ссылка) Замена родной материнской платы | - Нужны навыки пайки или обжимания клемм совместимой с платой на которую вы будете менять <br> - Придется докупать бп на 24в, твердотельные реле для работы сушки. -В ace достаточно мало место для этого всего, придется выносить на корпус | - Есть возможность вернуться обратно, в случае если вам не понравится hh |
| Прошивка стоковой платы swd или dfu | -Теряется возможность вернуться на стоковую прошивку(даже если сняли дамп с процессора, по крайней мере у меня не получилось)<br> - Для обновление прошивки нужен будет программатор(у меня не удалось запустить katapult)| - Если брали паяльник в руки хоть раз, то этого достаточно |

# Сушилки 
На борту у ace pro имеется по 1 нагревателю, термистору, вентилятору на каждую секцию. Один транзистор управляет питанием сразу двух секций и приходится осуществлять контроль температуры только по одному термистору, второй просто выводит температуру. А также если отключится вентилятор охлаждающий нагреватель он просто перегреется и клиппер не упадет в ошибку, но хорошо что anycubic подумали и поставили термопредохранитель под нагревателем (на 100 градусов). Эти проблемы можно решить с помощью дополнительного твердотельного реле, но его придется выносить за корпус т.к в ней просто нету места. А также не известно максимальная температура сушки при которой не поплывет пластик, макисмальная которую прбовал 65 градусов (в камере)      



# Прошивка стоковой платы через swd
У разных ревизий плат отличается внутренняя строение. 

Первая ревизия(0.0.8) - закрытый бп, твердотельное реле на нагреватели(испоьльзуется watermark!) 

Вторая ревизия(0.0.9) - открытый бп, транзистор на нагреватели 

![Alt-текст](https://github.com/printers-for-people/ACEResearch/blob/d7145cf57ede717a8d92506ea8acc05371e99e26/photos/IMG_1301.JPG)

__!!! В зависимости от вашей ревизии платы советую проверять распиновку и конфиги !!!__

Дальше в статье будут конфиги именно под 0.0.9 

Итак BOM 
- st link v2
- резистор 1,5 ком для подтяжки 3,3в к D+
- Колодки / дюпонты(скорее опцианально, можно и припаятся)
  
## Процесc прошивки:
Прежде хотел сказать то что в интернете достаточно много информации по прошовке stm32 с помощью st link, для gd32 процесс аналогичен  

1) Подключаем st link к плате. При питании ace pro от 220 подключаем gnd, swlk, sclk, если нет то подключаем еще 3,3в.
   
	![Alt-текст](https://github.com/saturnechek/conversion-of-anycubic-ace-pro-to-happy-hare/blob/3ed1990230bfc7427506d5a0d0f0fb49e8a9e4b6/photos/pinout.png)

3) Подключаемся по ssh, собираем прошивку с такими параметрами, достаем с хоста(с помощью win scp или другим файловым проводником)

	![Alt-текст](https://github.com/saturnechek/conversion-of-anycubic-ace-pro-to-happy-hare/blob/1b01261e31c6ff0b7a432ea29c4232ead8a769b6/photos/menuconfig.png)

```
cd klipper
make clean 
make menuconfug
make
```
  
3) Устанавливаем драйвера и программу STM32 ST-LINK Utility. 

  __!!! ОБРАТНОГО ПУТИ УЖЕ НЕ БУДЕТ !!!__

4) Открываем файл прошивки, отключаем питание ace, включаем и конектим в STM32 ST-LINK Utility(обязательно в такой последовательности, иначе будет выпадать ошибка что не возможно подключиться). 
	
5) Паяем резистор к d+ и 3.3в, а также делаем технологический вырез в корпусе (если припаяли под платой)
   
6) Дальше есть несколько путей подключения: 
	1) Использовать стоковый хаб(понадобиться провод microfit - usb)
	2) Припаяться к пинам и вывести удобный для вас разъем

7) Если все прошло удачно, то в веб интерфейсе отобразится устройство или ls /dev/ttyACM*
   
	![Alt-текст](https://github.com/saturnechek/conversion-of-anycubic-ace-pro-to-happy-hare/blob/1b01261e31c6ff0b7a432ea29c4232ead8a769b6/photos/ls%20dev.png)

	![Alt-текст](https://github.com/saturnechek/conversion-of-anycubic-ace-pro-to-happy-hare/blob/1b01261e31c6ff0b7a432ea29c4232ead8a769b6/photos/device%20mainsail.png)

# Прошивка стоковой материнской платы через DFU
Anycubic вывели пин boot0 к gnd через резистор, а рядом расположили пятку vcc. Узнал я это уже после того как прошил через swd, так что не могу утверждать что способ сработает, ведь не известно что производитель сделал с загрузчиком, а также по какой то не веданной мне причине в dfu устройство не видится не через лс дев не через ls /dev/ttyACM*
	![Alt-текст](https://github.com/saturnechek/conversion-of-anycubic-ace-pro-to-happy-hare/blob/1b01261e31c6ff0b7a432ea29c4232ead8a769b6/photos/pinout%20dfu%20mode.png)

Если захотите попробовать:
1) Отпаиваем резистор BOOT0-GND
2) Паяемся BOOT0-VCC
3) Насчет прошивки никак не подскажу, сам не проходил этот этап 
 
Переходим к настройке happy hare
