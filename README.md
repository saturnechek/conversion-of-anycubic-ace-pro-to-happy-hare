# Перевод anycubic ace pro на happy hare
Данная статья посвящена переведу anycubic ace pro на happy hare. Статья подразумевает что у вас уже поставлен klipper, веб интрфейс, а также умеете подключаться к хосту по ssh и вы имеете представления о stm32, klipper

Если вы наткнулись на эту статью и не готовы так заморачиваться, можете воспользоваться данными проектами
- https://github.com/BlackFrogKok/BunnyACE/blob/development/README.ru.md
- https://github.com/agrloki/ValgACE

Преимущества над выше перечисленными проектами:
- Гибкость настройки 
- Стабильность работы 
- Удобный веб интерфейс
- klipperscreen под mmu 
- Возможность подключения к самой асе дополнительных датчиков(если ну нужен nfc освобождается 12 пинов), например таких как bme280(для отображения реальной температуры и влажности в камере сушилки, а не погоду в блоке грелок), дисплеев и тд 


Для понятности 
| Обозначение | Сокращение |
|:----:|:----:|
| Happy hare | hh |
| Anycubic ace pro | ace |
| Блок питанияe | бп |


Есть несколько путей для реализации этой идеи:

| Путь | Минусы | Плюсы |
|:----:|:------|:------|
| Замена родной материнской платы | Нужны навыки пайки или обжимания клемм совместимой с платой на которую вы будете менять <br> Придется докупать бп на 24в, твердотельные реле для работы сушки. В ace достаточно мало место для этого всего, придется выносить на корпус| Есть возможность вернуться обратно, в случае если вам не понравится hh |
| Прошивка стоковой платы swd или dfu | Теряется возможность вернуться на стоковую прошивку(даже если сняли дамп с процессора, по крайней мере у меня не получилось)<br> Для обновление прошивки нужен будет программатор(у меня не удалось запустить katapult)| Есть возможность вернуться обратно, в случае если вам не понравится hh |

# Реализация сушилки 
На борту у ace pro имеется по 1 нагревателю, термистору, вентилятору на каждую секцию. Один транзистор управляет питанием сразу двух секций и приходится осуществлять контроль температуры только по одному термистору, второй просто выводит температуру. А также если отключится вентилятор охлаждающий нагреватель он просто перегреется и клиппер не упадет в ошибку, но хорошо что anycubic подумали и поставили термопредохранитель под нагревателем. Эти проблемы можно решить с помощью дополнительного твердотельного реле, но его придется выносить за корпус т.к в ней просто нету места      



# Прошивка стоковой платы через swd
На сколько мне известно у разных ревизий плат отличается внутренняя строение. У меня плата 0.0.9 которая имеет отрытый бп, транзистор на нагреватели. 
Плата 0.0.8 имеет закрытый бп, твердотельное реле.

__!!! В зависимости от вашей ревизии платы советую проверять распиновку и конфиги !!!__

Дальше в статье будут конфиги именно под 0.0.9 

Итак BOM 
- st link v2
- резистор 1,5 ком для подтяжки 3,3в к D+
- Колодки / дюпонты(скорее опцианально, можно и припаятся)
  
## Процесc прошивки:
Прежде хотел сказать то что в интернете достаточно много информации по прошовке stm32 с помощью st link, для gd32 процесс аналогичен  

1) Подключаем st link к плате. При питании ace pro от 220 подключаем gnd, swlk, sclk, если нет то подключаем еще 3,3в.  

2) Подключаемся по ssh, собираем прошивку с такими параметрами, достаем с хоста(с помощью win scp или другим файловым проводником) 
```
cd klipper
make clean 
make menuconfug
make
```
  
3) Устанавливаем драйвера и программу STM32 ST-LINK Utility. 

  __!!! ОБРАТНОГО ПУТИ УЖЕ НЕ БУДЕТ !!!__

4) Открываем файл прошивки, отключаем питание ace, включаем и конектим в STM32 ST-LINK Utility(обязательно в такой последовательности, иначе будет выпадать ошибка что не возможно подключиться). 

5) Паяем резистор к d+ и 3.3в, а также делаем технологический вырез(если сделали как и я)
   
6) Дальше есть несколько путей подключения: 
	1) Использовать стоковый хаб(понадобиться провод micro fitS-usb)
	2) Припаяться к пинам и вывести удобный для вас разъем

7) Если все прошло удачно, то в веб интерфейсе отобразится устройство или ls /dev/ttyACM*

# Прошивка стоковой материнской платы через DFU
Anycubic вывели пин boot0 к gnd через резистор, а рядом расположили пятку vcc. Узнал я это уже после того как прошил через swd, так что не могу утверждать что способ сработает, ведь не известно что производитель сделал с загрузчиком, а также по какой то не веданной мне причине в dfu устройство не видится не через лс дев не через ls /dev/ttyACM*

	1) boot0  
	2) gnd
	3) vcc
  
Если захотите попробовать:
1) Отпаиваем резистор 1-2
2) Паяемся 1-3
3) Насчет прошивки никак не подскажу, сам не проходил этот этап 
 
Переходим к настройке happy hare
